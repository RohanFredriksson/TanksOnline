<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tanks Online</title>
  <link rel="stylesheet" type="text/css" href="css/main.css" />
  <meta name="viewport" content="width=device-width">
</head>
<body class="hidden-scroll nooverflow">

  <header class="headertitle">
    <p style="padding-top: 0.4vh; padding-left: 1vh;">Tanks Online</p> 
  </header>

  <div class="bg"></div>
  <div class="bg bg2"></div>
  <div class="bg bg3"></div>

  <div id="desktop">

    <!-- Message Box -->
    <div id="desktop_message_box" class="desktopmessage content">
      <p id="desktop_message" style="font-size:1.5vw;"></p>
    </div>

    <!-- Landing Page Button Box -->
    <div id="desktop_landing">
      <div class="desktopbox content" style="margin-left: 17.5%;">

        <!-- Create Room Button -->
        <div id="desktop_create_room_button" class="content hoverable" style="margin-top: 10%; margin-left:10%; width:80%; height:12.5%; background-color: whitesmoke;">
            <p style="font-size:2.5vw; -ms-transform: translateY(0.75vw); transform: translateY(0.75vw);">Create a Room</p>
        </div>

        <!-- Join Room Button and Text Bar -->
        <div style="margin-top: 10%; margin-left:10%; width:80%; height:12.5%;">

          <!-- Text Bar -->
          <div class="content hoverable" style="float:left; width:60%; height:100%; background-color: whitesmoke;">
            <input id="desktop_join_room_input" maxlength="4" spellcheck="false" class="inputbox" style="font-size:2.5vw; background-color: whitesmoke; text-transform: uppercase;"></input>
          </div>

          <!-- Join Room Button -->
          <div id="desktop_join_room_button" class="content hoverable" style="margin-left: 10%; float:left; width:30%; height:100%; background-color: whitesmoke;">
            <p style="margin-top:0.75vw ;font-size:2.5vw">Join</p>
          </div>

        </div>

      </div>
      
      <!-- Tank Customisation Box -->
      <div class="desktopbox content" style="margin-left: 52.5%;">

      </div>
    </div>

    <!-- Game Box -->
    <div id="desktop_game" class="desktopgame content">

      <!-- Host Start Menu -->
      <div id="desktop_start" class="gamescreen">

      </div>

      <!-- Waiting Area -->
      <div id="desktop_waiting" class="gamescreen">
        <canvas id="desktop_tank_waiting_0" class="tankwaiting" style="top: 60%;"></canvas>
        <canvas id="desktop_tank_waiting_1" class="tankwaiting" style="top: 60%;"></canvas>
        <canvas id="desktop_tank_waiting_2" class="tankwaiting" style="top: 60%;"></canvas>
        <canvas id="desktop_tank_waiting_3" class="tankwaiting" style="top: 60%;"></canvas>
      </div>

      <!-- Buy Menu -->
      <div id="desktop_buy" class="gamescreen">

      </div>

      <!-- Map -->
      <div id="desktop_map" class="gamescreen">

      </div>

    </div>

  </div>

  <div id="phone">

    <!-- Landing Page Button Box -->
    <div class="phonebox content" style="margin-left: 17.5%;">
      
    </div>

  </div>

  <div id="wide">

    <!-- Message Box -->
    <div id="wide_message_box" class="widemessage content">
      <p id="wide_message" style="font-size:3vh;"></p>
    </div>

    <!-- Landing Page Button Box -->
    <div id="wide_landing">
      <div class="widebox content" style="margin-left: 52.5%; -ms-transform: translate(-70vh,-47%); transform: translate(-70vh,-47%);">
        
        <!-- Create Room Button -->
        <div id="wide_create_room_button" class="content hoverable" style="margin-top: 10%; margin-left:10%; width:80%; height:12.5%; background-color: whitesmoke;">
          <p style="font-size:5vh; -ms-transform: translateY(1.5vh); transform: translateY(1.5vh);">Create a Room</p>
        </div>

        <!-- Join Room Button and Text Bar -->
        <div style="margin-top: 10%; margin-left:10%; width:80%; height:12.5%;">

          <!-- Text Bar -->
          <div class="content hoverable" style="float:left; width:60%; height:100%; background-color: whitesmoke;">
            <input id="wide_join_room_input" maxlength="4" spellcheck="false" class="inputbox" style="font-size:5vh; background-color: whitesmoke; text-transform: uppercase;"></input>
          </div>

          <!-- Join Room Button -->
          <div id="wide_join_room_button" class="content hoverable" style="margin-left: 10%; float:left; width:30%; height:100%; background-color: whitesmoke;">
            <p style="margin-top:1.5vh ;font-size:5vh">Join</p>
          </div>

        </div>

      </div>
      
      <!-- Tank Customisation Box -->
      <div class="widebox content" style="margin-left: 52.5%;">
        
      </div>
    </div>

    <!-- Game Box -->
    <div id="wide_game" class="widegame content" style="margin-left: 52.5%; -ms-transform: translate(-70vh,-47%); transform: translate(-70vh,-47%);">

      <!-- Host Start Menu -->
      <div id="wide_start" class="gamescreen">

      </div>

      <!-- Waiting Area -->
      <div id="wide_waiting" class="gamescreen">
        <canvas id="wide_tank_waiting_0" class="tankwaiting" style="top: 60%;"></canvas>
        <canvas id="wide_tank_waiting_1" class="tankwaiting" style="top: 60%;"></canvas>
        <canvas id="wide_tank_waiting_2" class="tankwaiting" style="top: 60%;"></canvas>
        <canvas id="wide_tank_waiting_3" class="tankwaiting" style="top: 60%;"></canvas>
      </div>

      <!-- Buy Menu -->
      <div id="wide_buy" class="gamescreen">

      </div>

      <!-- Map -->
      <div id="wide_map" class="gamescreen">

      </div>

    </div>

  </div>

  <script>

    desktopLanding = document.getElementById('desktop_landing');
    desktopGame = document.getElementById('desktop_game');

    wideLanding = document.getElementById('wide_landing');
    wideGame = document.getElementById('wide_game');

    // Functions to switch between screens.

    // Switch the screen to the game screen.
    function displayGame() {

      desktopLanding.style.display = 'none';
      desktopGame.style.display = 'block';

      wideLanding.style.display = 'none';
      wideGame.style.display = 'block';

    }

    // Switch the screen to the landing screen.
    function displayLanding() {

      desktopLanding.style.display = 'block';
      desktopGame.style.display = 'none';

      wideLanding.style.display = 'block';
      wideGame.style.display = 'none';

    }

  </script>

  <script>

    // Create message functionality.
    desktopMessageBox = document.getElementById('desktop_message_box');
    wideMessageBox = document.getElementById('wide_message_box');

    desktopMessage = document.getElementById('desktop_message');
    wideMessage = document.getElementById('wide_message');

    sendMessageTimeout = null;
    async function sendMessage(m) {
      
      // If the timeout is already running, stop it.
      if (sendMessageTimeout != null) {
        clearTimeout(sendMessageTimeout)
        sendMessageTimeout = null
      }

      // Change the message in the box.
      desktopMessage.innerHTML = m;
      wideMessage.innerHTML = m;

      // Make the message box visible.
      desktopMessageBox.style.opacity = 100;
      wideMessageBox.style.opacity = 100;

      // Make the message box disappear after 3 seconds.
      sendMessageTimeout = setTimeout(() => {
        desktopMessageBox.style.opacity = 0;
        wideMessageBox.style.opacity = 0;
      },3000);
      
    }

  </script>

  <script>

    var ip = "<%- ip %>";
    var id = "";
    var isConnected = false;
    var inRoom = false;
    var gameData = null;

    var socket = new WebSocket("ws://192.168.1.5:8999");
    // var socket = new WebSocket("ws://" + ip  +":8999");

    socket.onopen = function (event) {
      isConnected = true;
      getId();
      checkInRoom();
    };

    socket.onclose = function (event) {
      isConnected = false;
      inRoom = false;
      displayLanding();
    }

    socket.onmessage = function (event) {
      
      message = event.data;
      message = JSON.parse(message);

      if ("type" in message) {

        if (message.type == 'game_data') {
          gameData = message.data;
          drawGame();
        } 
        
        else if (message.type == 'in_room') {
          inRoom = message.data;

          // Ensure the user is on the current screen.
          if (inRoom) {displayGame();} 
          else {displayLanding();}

        } 
        
        else if (message.type == 'id') {
          id = message.data;
        }

        else if (message.type == 'message') {
          sendMessage(message.data);
        }

      }

    }

    // Will create a room and join it if you are not in a room.
    function createRoom() {
      if (isConnected) {
        socket.send(JSON.stringify({command:"create",args:[]}));
        checkInRoom();
      } 
    }

    // Joins the room with the given number.
    function joinRoom(room) {
      if (isConnected) {
        socket.send(JSON.stringify({command:"join",args:[room]}));
        checkInRoom();
      }
    }

    // Sends input command to the room.
    function input(command) {
      if (isConnected) {
        socket.send(JSON.stringify({command:"input",args:[command]}));
      }
    }

    // Will update the inRoom variable.
    function checkInRoom() {
      if (isConnected) {
        socket.send(JSON.stringify({command:"in_room",args:[]}));
      }
    }

    // Will request game data from the server.
    function requestGameData() {
      if (isConnected) {
        socket.send(JSON.stringify({command:"get_game_data",args:[]}));
      }
    }

    // Will request the player id from the server.
    function getId() {
      if (isConnected) {
        socket.send(JSON.stringify({command:"get_id",args:[]}));
      }
    }

    // Will make the player leave the room if in a room.
    function leaveRoom() {
      if (isConnected) {
        socket.send(JSON.stringify({command:"leave_room",args:[]}));
      }
    }
    
  </script>

  <script>

    // Join Room Box
    desktopJoinRoomInput = document.getElementById('desktop_join_room_input');
    wideJoinRoomInput = document.getElementById('wide_join_room_input');

    // Synchronise changes between the two boxes. If one changes, change the other one.
    desktopJoinRoomInput.onkeyup = function(e) {
      // If the user hit enter, try and join the room.
      if (e.key === "Enter") {
        roomNumber = desktopJoinRoomInput.input;
        joinRoom(roomNumber);
      }
      else {
        newValue = desktopJoinRoomInput.value
        if (newValue.length > 4) {newValue = newValue.substring(0,4);}
        wideJoinRoomInput.value = newValue;
      }
    }

    // Synchronise changes between the two boxes. If one changes, change the other one.
    wideJoinRoomInput.onkeyup = function(e) {
      // If the user hit enter, try and join the room.
      if (e.key === "Enter") {
        roomNumber = wideJoinRoomInput.value;
        joinRoom(roomNumber);
      }
      else {
        newValue = wideJoinRoomInput.value
        if (newValue.length > 4) {newValue = newValue.substring(0,4);}
        desktopJoinRoomInput.value = newValue;
      }
    }

    // Join Room Buttons
    desktopJoinRoomButton = document.getElementById('desktop_join_room_button');
    wideJoinRoomButton = document.getElementById('wide_join_room_button');

    // If the join button is pressed, join the room.
    desktopJoinRoomButton.onclick = function(e) {
      roomNumber = desktopJoinRoomInput.value;
      joinRoom(roomNumber);
    }

    // If the join button is pressed, join the room.
    wideJoinRoomButton.onclick = function(e) {
      roomNumber = wideJoinRoomInput.value;
      joinRoom(roomNumber);
    }

    // Create Room Buttons
    desktopCreateRoomButton = document.getElementById('desktop_create_room_button');
    wideCreateRoomButton = document.getElementById('wide_create_room_button');

    // When clicking the button join the room.
    desktopCreateRoomButton.onclick = createRoom;
    wideCreateRoomButton.onclick = createRoom;

  </script>

  <script>

    desktopStart = document.getElementById('desktop_start');
    desktopWaiting = document.getElementById('desktop_waiting');
    desktopBuy = document.getElementById('desktop_buy');
    desktopMap = document.getElementById('desktop_map');

    wideStart = document.getElementById('wide_start');
    wideWaiting = document.getElementById('wide_waiting');
    wideBuy = document.getElementById('wide_buy');
    wideMap = document.getElementById('wide_map');

    // Draw the game.
    function drawGame() {

      // Check if the game data exists.
      if (gameData == null) {
        return;
      }

      // If the game hasn't started yet.
      if (gameData.started == false) {

        // If the player is a host, display the host menu.
        for (let i = 0; i < gameData.players.length; i = i + 1) {
          player = gameData.players[i];

          if (id == player.id) {
            if (player.isHost) {
              displayWaiting();
              //displayStart();
              return;
            }
          }
          
        }

        // Else display the normal waiting screen.
        displayWaiting();
        return;

      }

      // If the game is in the buy period, show the buy period menu.
      if (gameData.inBuyPeriod) {
        displayBuy();
        return;
      }

      // Else display the map.
      displayGame();

    }

    // Display the start menu for the host.
    function displayStart() {

      console.log("Start");
      desktopStart.style.display = 'block';
      desktopWaiting.style.display = 'none';
      desktopBuy.style.display = 'none';
      desktopMap.style.display = 'none';

      wideStart.style.display = 'block';
      wideWaiting.style.display = 'none';
      wideBuy.style.display = 'none';
      wideMap.style.display = 'none';

    }

    // Display the start waiting screen for other players.
    function displayWaiting() {

      console.log("Waiting");
      desktopStart.style.display = 'none';
      desktopWaiting.style.display = 'block';
      desktopBuy.style.display = 'none';
      desktopMap.style.display = 'none';

      wideStart.style.display = 'none';
      wideWaiting.style.display = 'block';
      wideBuy.style.display = 'none';
      wideMap.style.display = 'none';

      tank = document.getElementById('desktop_tank_waiting_0');
      console.log(tank)
      drawTank(tank,"#FF00FF");

    }

    // Display the shop menu.
    function displayBuy() {

      console.log("Buy");
      desktopStart.style.display = 'none';
      desktopWaiting.style.display = 'none';
      desktopBuy.style.display = 'block';
      desktopMap.style.display = 'none';

      wideStart.style.display = 'none';
      wideWaiting.style.display = 'none';
      wideBuy.style.display = 'block';
      wideMap.style.display = 'none';

    }

    // Display the map.
    function displayMap() {

      console.log("Map");
      desktopStart.style.display = 'none';
      desktopWaiting.style.display = 'none';
      desktopBuy.style.display = 'none';
      desktopMap.style.display = 'block';

      wideStart.style.display = 'none';
      wideWaiting.style.display = 'none';
      wideBuy.style.display = 'none';
      wideMap.style.display = 'block';

    }

  </script>

  <script>

    function drawCircle(ctx,colour,x,y,r) {
      ctx.fillStyle = colour;
      ctx.beginPath();
      ctx.arc(x,y,r,0,2 * Math.PI, false);
      ctx.closePath();
      ctx.fill();
    }

    function drawRoundedRectangle(ctx,colour,x,y,w,h,r) {
      if (w < 2 * r) r = w / 2;
      if (h < 2 * r) r = h / 2;
      ctx.fillStyle = colour;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y,   x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x,   y+h, r);
      ctx.arcTo(x,   y+h, x,   y,   r);
      ctx.arcTo(x,   y,   x+w, y,   r);
      ctx.closePath();
      ctx.fill();

      console.log(ctx);
    }

    function drawTank(tankCanvas,colour) {
      
      width = tankCanvas.getBoundingClientRect().width;
      height = tankCanvas.getBoundingClientRect().height;

      ctx = tankCanvas.getContext('2d');
      drawCircle(ctx,colour,0.25*width,0.9*height,0.1*height);
      drawCircle(ctx,colour,0.75*width,0.9*height,0.1*height);
      drawRoundedRectangle(ctx,colour,0.25*width,0.58*height,0.5*width,0.42*height,0.07*width);

    }

  </script>

</body>
</html>